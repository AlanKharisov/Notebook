<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Кулінарна книга</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* ===== Палітра та базові змінні ===== */
        :root{
            /* твої трав'яні кольори */
            --grass-1: #35da0d;  /* яскравий трав'яний */
            --grass-2: #1c6204;  /* глибший трав'яний */

            /* мапуємо на тему */
            --primary-color: var(--grass-1);
            --secondary-color: var(--grass-2);
            --primary-light: #57b833;   /* світліший відтінок для hover */
            --accent-color: #49b028;    /* акцент (м'який лайм/трава) */

            --text-color: #0f172a;      /* темно-сланцевий текст */
            --light-text: #ffffff;      /* білий текст на зеленому */
            --background: #f8fafc;      /* дуже світлий фон */
            --card-bg: #ffffff;         /* картки білі */
            --border: #e5e7eb;          /* світлі межі */

            --shadow: 0 8px 22px rgba(2, 6, 23, 0.06);
            --radius: 14px;
            --transition: all .25s ease;

            /* типографіка — збільшено для комфортного читання */
            --base-font: 18px;
            --h1: 1.65rem;
            --h3: 1.3rem;
            --text: 1rem;
            --button: 1rem;
            --small: .95rem;
        }

        /* ===== Нормалізація та база ===== */
        html{ font-size: var(--base-font); }
        *, *::before, *::after{ box-sizing: border-box; }
        body{
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin:0; padding:0;
            background: var(--background);
            color: var(--text-color);
            line-height: 1.65;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== Хедер ===== */
        .header{
            display:flex; justify-content: space-between; align-items:center;
            background: var(--primary-color);
            padding: .9rem 1.2rem;
            position: sticky; top:0; z-index:100;
            box-shadow: var(--shadow);
            border-bottom: 1px solid rgba(255,255,255,.08);
        }
        .header h1{
            flex:1; text-align:center; margin:0;
            color:var(--light-text); font-size:var(--h1); font-weight:700;
        }
        .header button{
            appearance:none; -webkit-appearance:none;
            background: rgba(255,255,255,.12);
            border: 1px solid rgba(255,255,255,.22);
            color: var(--light-text);
            padding: .6rem 1rem;
            border-radius: 999px;
            font-size: var(--button); font-weight:700;
            cursor:pointer; transition: var(--transition);
            backdrop-filter: saturate(120%) blur(2px);
        }
        .header button:hover{ background: rgba(255,255,255,.2); transform: translateY(-1px); }
        .header button:focus-visible{
            outline: 3px solid rgba(73,176,40,.35);
            outline-offset: 2px;
        }

        /* ===== Контейнер ===== */
        .main{ padding: 1.25rem; max-width: 920px; margin: 0 auto; }
        h3{ color: var(--secondary-color); margin: 0 0 1.1rem; font-size: var(--h3); font-weight:800; }

        /* ===== Категорії ===== */
        .category{
            margin-bottom: 1rem; background: var(--card-bg);
            border: 1px solid var(--border); border-radius: var(--radius);
            box-shadow: var(--shadow); transition: var(--transition); overflow:hidden;
        }
        .category:hover{ transform: translateY(-2px); box-shadow: 0 10px 26px rgba(2,6,23,.08); }
        .category-header{
            display:flex; align-items:center; gap:.75rem;
            padding: .85rem 1rem;
            background: var(--secondary-color);
            color: var(--light-text);
        }
        .category button{
            border:none; background:none; color:inherit;
            font-size: var(--text); font-weight:700; text-align:left; flex:1; cursor:pointer;
        }
        .category-actions{ display:flex; gap:.7rem; }
        .category-actions img{
            width:22px; height:22px; cursor:pointer; transition: var(--transition);
            filter: brightness(0) invert(1);
        }
        .category-actions img:hover{ transform: scale(1.08); }

        /* ===== Страви ===== */
        .dishes{ display:none; padding: 0 1rem 1rem; background: var(--card-bg); }
        .dish{
            display:flex; align-items:center; gap:.75rem;
            padding: .8rem 0; border-bottom:1px solid var(--border);
            transition: var(--transition);
        }
        .dish:last-child{ border-bottom:none; }
        .dish:hover{ background: #f1fbf3; }  /* легкий зелений тінт */
        .dish button{
            flex:1; border:none; background:none; text-align:left; cursor:pointer;
            font-size: var(--text); font-weight:600; color: var(--text-color);
            padding:.35rem 0; transition: var(--transition);
        }
        .dish button:hover{ color: var(--primary-color); padding-left: 4px; }
        .dish-actions{ display:flex; gap:.6rem; }
        .dish-actions img{ width:22px; height:22px; cursor:pointer; transition: var(--transition); }
        .dish-actions img:hover{ transform: scale(1.08); }

        /* ===== Кнопки (усі стани) ===== */
        .button{
            appearance:none; -webkit-appearance:none;
            background: var(--primary-color);
            color: var(--light-text);
            border: 1px solid rgba(73,176,40,.18);
            padding: .85rem 1.2rem;
            border-radius: var(--radius);
            cursor:pointer; transition: var(--transition);
            font-size: var(--button); font-weight:800; letter-spacing:.2px;
            width:100%; margin:.85rem 0;
            box-shadow: var(--shadow);
        }
        .button:hover{ background: var(--primary-light); transform: translateY(-1px); }
        .button:active{ transform: translateY(0); }
        .button:focus-visible{
            outline: 3px solid rgba(73,176,40,.35);
            outline-offset: 2px;
        }

        /* вторинна/акцентна */
        .button.secondary{
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            border: 1px solid rgba(73,176,40,.2);
            color: var(--light-text);
            padding: .85rem 1.1rem;
            border-radius: var(--radius);
            font-weight:800;
            box-shadow: 0 8px 20px rgba(73,176,40,.18);
            width:auto;
        }
        .button.secondary:hover{
            background: linear-gradient(135deg, var(--accent-color), var(--primary-light));
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(73,176,40,.24);
        }

        /* outline-кнопка «Назад» */
        .button.back{
            background: none;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: .5rem 1rem;
            border-radius: 999px;
            font-size: var(--small); font-weight:800;
            width:auto; box-shadow:none;
        }
        .button.back:hover{ background: var(--primary-color); color: var(--light-text); transform: translateY(-1px); }
        .button.back:focus-visible{
            outline: 3px solid rgba(73,176,40,.35);
            outline-offset: 2px;
        }

        /* ===== Інпути ===== */
        .input-group{ margin-bottom: 1.2rem; }
        .input-group input,
        .auth-form input{
            width:100%; padding: .8rem 1rem;
            border:1px solid var(--border); border-radius: var(--radius);
            background:#fff; color: var(--text-color);
            font-size: var(--text); transition: var(--transition);
        }
        .input-group input:focus,
        .auth-form input:focus{
            outline:none; border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(73,176,40,.22);
        }

        /* ===== Рецепт ===== */
        .recipe-content{
            margin: 1.2rem 0; padding:0;
            font-size: 1.125rem; line-height:1.8;
            color: var(--text-color);
            white-space: pre-wrap;
            word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;
            max-width:100%; overflow-x:auto;
        }
        .recipe-content.edit-mode{
            background:#f6fdf4;
            border:1px solid var(--primary-light);
            padding: 1.1rem; min-height: 280px;
            border-radius: var(--radius); outline:none; cursor:text;
        }
        .recipe-actions{ display:flex; gap:.8rem; margin-top:.6rem; }
        .recipe-actions button{ width:auto; margin:0; }

        /* ===== Модалка логіну/реєстрації ===== */
        .auth-form{
            position:fixed; inset:0;
            background: rgba(0,0,0,.55);
            display:flex; justify-content:center; align-items:center;
            z-index:1000; backdrop-filter: blur(3px);
        }
        .auth-form .form-container{
            background: var(--card-bg);
            padding: 1.4rem; border-radius: var(--radius);
            box-shadow: 0 16px 36px rgba(2,6,23,.16);
            width:92%; max-width: 440px;
            border: 1px solid var(--border);
            animation: fadeInUp .35s ease-out;
        }
        .auth-form h3{
            text-align:center; margin: 0 0 1rem;
            color: var(--secondary-color); font-weight:800; font-size: var(--h3);
        }
        .auth-form .error-message{
            color:#dc2626; margin-bottom: 1rem; text-align:center; font-size: .95rem;
        }
        .auth-form .switch-form{
            background:none; border:none; color: var(--primary-color);
            cursor:pointer; font-size: var(--small); font-weight:800;
            display:block; margin:.6rem auto 0; text-align:center; width:100%;
            padding:.4rem 0; transition: var(--transition);
        }
        .auth-form .switch-form:hover{ color: var(--primary-light); text-decoration: underline; }

        /* ===== Навігація екранів ===== */
        /* (залишаємо поведінку з JS, стилі базові вже є) */

        /* ===== Адаптив ===== */
        @media (max-width: 768px){
            .header{ padding: .7rem .9rem; flex-wrap: wrap; }
            .header button{ margin:.25rem; font-size: .95rem; }
            .main{ padding: .95rem; }
            .category-header{ padding:.75rem .9rem; }
        }

        /* ===== Анімації ===== */
        @keyframes fadeIn{
            from{ opacity:0; transform: translateY(8px); }
            to{ opacity:1; transform: translateY(0); }
        }
        @keyframes fadeInUp{
            from{ opacity:0; transform: translateY(16px); }
            to{ opacity:1; transform: translateY(0); }
        }
        .category, .dish, .recipe-content, .button{ animation: fadeIn .35s ease-out; }
    </style>
</head>
<body>
<div class="header">
    <button id="authButton" onclick="toggleAuthMenu()">Увійти</button>
    <button onclick="showAddMenu()">Додати категорію</button>
</div>

<div id="main-menu" class="main">
    <h3>Категорії страв</h3>
    <div id="categories"></div>
</div>

<div id="add-menu" class="main" style="display: none">
    <button class="button back" onclick="goBackFromRecipe()">⬅ Назад</button>
    <h3>Додати категорію</h3>
    <div class="input-group">
        <input
                type="text"
                id="new-category-name"
                placeholder="Назва категорії"
        />
        <button class="button" onclick="addNewCategory()">Додати</button>
    </div>
</div>

<div id="recipe-menu" class="main" style="display: none">
    <button class="button back" onclick="goBackFromRecipe()">⬅ Назад</button>
    <h3 id="recipe-title">Назва страви</h3>
    <div
            class="recipe-content"
            id="recipe-display"
            contenteditable="false"
    ></div>
    <div class="recipe-actions" id="recipe-actions" style="display: none">
        <button class="button" onclick="saveRecipe()">Зберегти</button>
        <button class="button secondary" onclick="cancelEdit()">
            Скасувати
        </button>
    </div>
    <button class="button" id="edit-button" onclick="startEdit()">
        Редагувати
    </button>
</div>

<!-- Auth Forms -->
<div id="auth-menu" class="auth-form" style="display: none">
    <div class="form-container">
        <div id="login-form">
            <h3>Увійти</h3>
            <div id="login-error" class="error-message"></div>
            <input type="email" id="login-email" placeholder="Email" />
            <input type="password" id="login-password" placeholder="Пароль" />
            <button class="button" onclick="login()">Увійти</button>
            <button class="switch-form" onclick="showRegisterForm()">
                Зареєструватися
            </button>
        </div>
        <div id="register-form" style="display: none">
            <h3>Реєстрація</h3>
            <div id="register-error" class="error-message"></div>
            <input type="text" id="register-name" placeholder="Ім'я" />
            <input type="email" id="register-email" placeholder="Email" />
            <input type="password" id="register-password" placeholder="Пароль" />
            <input
                    type="password"
                    id="register-confirm-password"
                    placeholder="Підтвердіть пароль"
            />
            <button class="button" onclick="register()">Зареєструватися</button>
            <button class="switch-form" onclick="showLoginForm()">
                Вже маєте акаунт? Увійти
            </button>
        </div>
    </div>
</div>

<script>
    // Конфигурация Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCsi129Y9ltNjMbNPU8D9s1JURMxVyeHYs",
        authDomain: "notebook-66f4e.firebaseapp.com",
        databaseURL: "https://notebook-66f4e-default-rtdb.firebaseio.com",
        projectId: "notebook-66f4e",
        storageBucket: "notebook-66f4e.appspot.com",
        messagingSenderId: "1234567890",
        appId: "1:1234567890:web:abcdef1234567890",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentCat = null;
    let currentDish = null;

    // ==================== Аутентификация ====================
    function toggleAuthMenu() {
        if (currentUser) {
            if (confirm("Вийти?")) {
                auth.signOut();
            }
        } else {
            document.getElementById("auth-menu").style.display = "flex";
            showLoginForm();
        }
    }

    function showLoginForm() {
        document.getElementById("login-form").style.display = "block";
        document.getElementById("register-form").style.display = "none";
        document.getElementById("login-error").textContent = "";
    }

    function showRegisterForm() {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("register-form").style.display = "block";
        document.getElementById("register-error").textContent = "";
    }

    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            hideAuthMenu();
            loadCategories();
            document.getElementById("authButton").textContent = "Вийти";
        } else {
            currentUser = null;
            document.getElementById("categories").innerHTML = "";
            document.getElementById("authButton").textContent = "Увійти";
            showMainMenu();
        }
    });

    function hideAuthMenu() {
        document.getElementById("auth-menu").style.display = "none";
    }

    function login() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const error = document.getElementById("login-error");

        auth
            .signInWithEmailAndPassword(email, password)
            .catch((err) => (error.textContent = err.message));
    }

    function register() {
        const name = document.getElementById("register-name").value.trim();
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;
        const confirm = document.getElementById(
            "register-confirm-password"
        ).value;
        const error = document.getElementById("register-error");

        if (password !== confirm) {
            error.textContent = "Паролі не співпадають";
            return;
        }

        auth
            .createUserWithEmailAndPassword(email, password)
            .then((cred) => {
                return db
                    .ref(`users/${cred.user.uid}/profile`)
                    .set({ name, email });
            })
            .then(() => {
                hideAuthMenu();
            })
            .catch((err) => (error.textContent = err.message));
    }

    // ==================== Категории ====================
    function loadCategories() {
        if (!currentUser) return;
        db.ref(`users/${currentUser.uid}/categories`)
            .once("value")
            .then((snap) => {
                const data = snap.val() || {};
                renderCategories(data);
            });
    }

    function renderCategories(categories) {
        const container = document.getElementById("categories");
        container.innerHTML = "";

        for (const [catId, cat] of Object.entries(categories)) {
            const div = document.createElement("div");
            div.className = "category";

            div.innerHTML = `
        <div class="category-header">
          <button onclick="toggleDishes('${catId}')">${escapeHtml(
                cat.name
            )}</button>
          <div class="category-actions">
            <img src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png" title="Редагувати категорію" onclick="editCategory('${catId}')" />
            <img src="https://cdn-icons-png.flaticon.com/512/484/484662.png" title="Видалити категорію" onclick="deleteCategory('${catId}')" />
          </div>
        </div>
        <div class="dishes" id="dishes-${catId}" style="display:none;"></div>
      `;

            container.appendChild(div);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    function showAddMenu() {
        document.getElementById("new-category-name").value = "";
        showScreen("add-menu");
    }

    function addNewCategory() {
        const name = document.getElementById("new-category-name").value.trim();
        if (!name) return alert("Введіть назву");

        const catId = db.ref().push().key;
        db.ref(`users/${currentUser.uid}/categories/${catId}`)
            .set({
                name,
                dishes: {},
            })
            .then(() => {
                showMainMenu();
                loadCategories();
            });
    }

    function editCategory(catId) {
        db.ref(`users/${currentUser.uid}/categories/${catId}/name`)
            .once("value")
            .then((snap) => {
                const oldName = snap.val() || "";
                const newName = prompt("Нова назва категорії:", oldName);
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    db.ref(`users/${currentUser.uid}/categories/${catId}/name`)
                        .set(newName.trim())
                        .then(loadCategories);
                }
            });
    }

    function deleteCategory(catId) {
        if (!confirm("Видалити категорію?")) return;
        db.ref(`users/${currentUser.uid}/categories/${catId}`)
            .remove()
            .then(loadCategories);
    }

    // ==================== Блюда ====================
    function toggleDishes(catId) {
        const container = document.getElementById(`dishes-${catId}`);
        if (container.style.display === "block") {
            container.style.display = "none";
            container.innerHTML = ""; // Очистить при закрытии
        } else {
            loadDishes(catId);
            container.style.display = "block";
        }
    }

    function loadDishes(catId) {
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes`)
            .once("value")
            .then((snap) => {
                const dishes = snap.val() || {};
                renderDishes(catId, dishes);
            });
    }

    function renderDishes(catId, dishes) {
        const container = document.getElementById(`dishes-${catId}`);
        container.innerHTML = `<button class="button secondary" onclick="addDish('${catId}')">+ Додати страву</button>`;

        for (const [dishId, dish] of Object.entries(dishes)) {
            container.insertAdjacentHTML(
                "beforeend",
                `
        <div class="dish">
          <button onclick="openDish('${catId}','${dishId}')">${escapeHtml(
                    dish.name
                )}</button>
          <div class="dish-actions">
            <img src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png" title="Редагувати страву" onclick="editDish('${catId}','${dishId}')" />
            <img src="https://cdn-icons-png.flaticon.com/512/484/484662.png" title="Видалити страву" onclick="deleteDish('${catId}','${dishId}')" />
          </div>
        </div>
      `
            );
        }
    }

    function addDish(catId) {
        const name = prompt("Назва страви?");
        if (!name || !name.trim()) return;
        const dishId = db.ref().push().key;
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}`)
            .set({
                name: name.trim(),
                description: "",
            })
            .then(() => loadDishes(catId));
    }

    function editDish(catId, dishId) {
        db.ref(
            `users/${currentUser.uid}/categories/${catId}/dishes/${dishId}/name`
        )
            .once("value")
            .then((snap) => {
                const oldName = snap.val() || "";
                const newName = prompt("Введіть нову назву страви:", oldName);
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    db.ref(
                        `users/${currentUser.uid}/categories/${catId}/dishes/${dishId}/name`
                    )
                        .set(newName.trim())
                        .then(() => loadDishes(catId));
                }
            });
    }

    function deleteDish(catId, dishId) {
        if (!confirm("Видалити страву?")) return;
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}`)
            .remove()
            .then(() => loadDishes(catId));
    }

    // ==================== Рецепт (описание) ====================
    function openDish(catId, dishId) {
        currentCat = catId;
        currentDish = dishId;
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}`)
            .once("value")
            .then((snap) => {
                const dish = snap.val();
                if (!dish) return alert("Страва не знайдена");
                document.getElementById("recipe-title").textContent = dish.name;
                document.getElementById("recipe-display").textContent =
                    dish.description || "";
                showScreen("recipe-menu");
                cancelEdit(); // Сбросить редактирование при открытии
            });
    }

    function startEdit() {
        const disp = document.getElementById("recipe-display");
        disp.contentEditable = "true";
        disp.classList.add("edit-mode");
        disp.focus();
        document.getElementById("edit-button").style.display = "none";
        document.getElementById("recipe-actions").style.display = "flex";
    }

    function saveRecipe() {
        const desc = document.getElementById("recipe-display").innerText.trim();
        db.ref(
            `users/${currentUser.uid}/categories/${currentCat}/dishes/${currentDish}/description`
        )
            .set(desc)
            .then(() => {
                cancelEdit();
            });
    }

    function cancelEdit() {
        document.getElementById("recipe-display").contentEditable = "false";
        document.getElementById("recipe-display").classList.remove("edit-mode");
        document.getElementById("edit-button").style.display = "block";
        document.getElementById("recipe-actions").style.display = "none";
    }

    // ==================== Навигация ====================
    function showScreen(id) {
        ["main-menu", "add-menu", "recipe-menu"].forEach((s) => {
            document.getElementById(s).style.display =
                s === id ? "block" : "none";
        });
    }

    function showMainMenu() {
        showScreen("main-menu");
        loadCategories();
    }

    function goBackFromRecipe() {
        showMainMenu();
    }

    // После успешного логина сохраняем аккаунт в localStorage
    function saveAccountToStorage(email, uid) {
        let accounts = JSON.parse(localStorage.getItem("accounts")) || [];
        if (!accounts.find((a) => a.email === email)) {
            accounts.push({ email, uid });
            localStorage.setItem("accounts", JSON.stringify(accounts));
        }
    }

    // Загружаем и показываем список аккаунтов
    function showAccountsList() {
        const accounts = JSON.parse(localStorage.getItem("accounts")) || [];
        const container = document.getElementById("accounts-list");
        container.innerHTML = "";
        accounts.forEach(({ email }) => {
            const btn = document.createElement("button");
            btn.textContent = email;
            btn.onclick = () => switchAccount(email);
            container.appendChild(btn);
        });
    }

    // При выборе аккаунта показываем форму ввода пароля и логиним
    function switchAccount(email) {
        const password = prompt(`Введите пароль для ${email}`);
        if (!password) return;
        auth.signOut().then(() => {
            auth
                .signInWithEmailAndPassword(email, password)
                .then(() => {
                    alert(`Вход выполнен под ${email}`);
                    loadCategories();
                })
                .catch((err) => alert(err.message));
        });
    }

    // Вызови showAccountsList() там, где хочешь показать выбор аккаунтов

    // ==================== Инициализация ====================
    document.addEventListener("DOMContentLoaded", () => {
        showMainMenu();
    });
</script>
</body>
</html>
