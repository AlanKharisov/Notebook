<!DOCTYPE html>
<html lang="uk" id="html-lang">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Кулінарна книга</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Иконки -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    :root {
        --primary: #35da0d;
        --secondary: #1c6204;
        --primary-light: #57b833;
        --accent: #49b028;
        --text: #0f172a;
        --muted: #64748b;
        --bg: #f8fafc;
        --card: #ffffff;
        --border: #e5e7eb;
        --shadow: 0 8px 22px rgba(2, 6, 23, 0.06);
        --radius: 14px;
        --transition: all .22s ease;
        
        /* Настройки размеров */
        --base-font-size: 18px;
        --h1-size: 1.55rem;
        --h2-size: 1.25rem;
        --h3-size: 1.1rem;
        --p-size: 1rem;
        --small-size: .92rem;
        --button-font-size: 1rem;
        --button-padding: .58rem .9rem;
        
        /* Настройки пользователя */
        --header-color: var(--primary);
        --edit-btn-color: var(--accent);
        --back-btn-color: var(--primary);
    }

    html {
        font-size: var(--base-font-size);
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.65;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* ===== Header ===== */
    .header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--header-color);
        box-shadow: var(--shadow);
        border-bottom: 1px solid rgba(255, 255, 255, .10);
    }

    .header__row {
        max-width: 980px;
        margin: 0 auto;
        padding: .85rem 1rem;
        display: flex;
        align-items: center;
        gap: .75rem;
    }

    .header__left,
    .header__right {
        display: flex;
        align-items: center;
        gap: .6rem;
        flex: 0 0 auto;
    }

    .header__title {
        flex: 1;
        text-align: center;
        margin: 0;
        font-size: var(--h1-size);
        font-weight: 900;
        color: #fff;
        letter-spacing: .2px;
        user-select: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .btn {
        appearance: none;
        border: 1px solid rgba(255, 255, 255, .22);
        background: rgba(255, 255, 255, .14);
        color: #fff;
        padding: var(--button-padding);
        border-radius: 999px;
        font-weight: 800;
        font-size: var(--button-font-size);
        cursor: pointer;
        transition: var(--transition);
        backdrop-filter: saturate(120%) blur(2px);
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        white-space: nowrap;
    }

    .btn:hover {
        background: rgba(255, 255, 255, .22);
        transform: translateY(-1px);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn:focus-visible {
        outline: 3px solid rgba(73, 176, 40, .35);
        outline-offset: 2px;
    }

    /* ===== Search bar ===== */
    .search-wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 0 1rem 1rem;
    }

    .search {
        display: flex;
        gap: .6rem;
        background: rgba(255, 255, 255, .18);
        border: 1px solid rgba(255, 255, 255, .22);
        border-radius: 999px;
        padding: .5rem .55rem;
        box-shadow: 0 10px 22px rgba(2, 6, 23, .08);
    }

    .search__input {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        color: #fff;
        font-size: var(--p-size);
        font-weight: 650;
        padding: .25rem .4rem;
    }

    .search__input::placeholder {
        color: rgba(255, 255, 255, .85);
        font-weight: 650;
    }

    .search__chip {
        border: 1px solid rgba(255, 255, 255, .24);
        background: rgba(255, 255, 255, .14);
        color: #fff;
        border-radius: 999px;
        padding: .42rem .7rem;
        font-weight: 800;
        font-size: var(--small-size);
        cursor: pointer;
        transition: var(--transition);
        white-space: nowrap;
    }

    .search__chip:hover {
        background: rgba(255, 255, 255, .22);
        transform: translateY(-1px);
    }

    /* ===== Layout ===== */
    .main {
        max-width: 980px;
        margin: 0 auto;
        padding: 1rem;
        padding-bottom: 2rem;
    }

    .screen {
        display: none;
    }

    .screen.is-active {
        display: block;
    }

    .section-title {
        margin: .35rem 0 1rem;
        font-size: var(--h2-size);
        font-weight: 900;
        color: var(--secondary);
    }

    /* ===== Cards ===== */
    .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    /* ===== Categories ===== */
    .category {
        margin-bottom: 1rem;
        transition: var(--transition);
    }

    .category:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 26px rgba(2, 6, 23, .09);
    }

    .category__head {
        display: flex;
        align-items: center;
        gap: .75rem;
        padding: .85rem 1rem;
        background: var(--secondary);
        color: #fff;
    }

    .category__toggle {
        flex: 1;
        border: none;
        background: none;
        color: inherit;
        text-align: left;
        font-size: var(--p-size);
        font-weight: 900;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: .5rem;
    }

    .category__meta {
        font-size: var(--small-size);
        opacity: .95;
        font-weight: 750;
        white-space: nowrap;
    }

    .category__actions {
        display: flex;
        gap: .55rem;
        flex: 0 0 auto;
    }

    .icon-btn {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, .18);
        background: rgba(255, 255, 255, .12);
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        color: #fff;
        font-size: var(--small-size);
    }

    .icon-btn:hover {
        background: rgba(255, 255, 255, .22);
        transform: translateY(-1px);
    }

    .icon-btn:active {
        transform: translateY(0);
    }

    .category__body {
        padding: .9rem 1rem 1rem;
    }

    .add-dish-btn-container {
        margin-bottom: .6rem;
        display: none;
    }

    .add-dish-btn-container.visible {
        display: block;
    }

    .btn-long {
        appearance: none;
        border: none;
        background: linear-gradient(135deg, var(--secondary), var(--accent));
        color: #fff;
        padding: .85rem 1rem;
        border-radius: 12px;
        font-weight: 900;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 10px 22px rgba(73, 176, 40, .18);
        white-space: nowrap;
        width: 100%;
        text-align: center;
        font-size: var(--button-font-size);
    }

    .btn-long:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 26px rgba(73, 176, 40, .24);
    }

    .btn-long:active {
        transform: translateY(0);
    }

    .dishes {
        display: none;
    }

    .dishes.is-open {
        display: block;
    }

    .dish {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .7rem;
        padding: .85rem .2rem;
        border-bottom: 1px solid var(--border);
        transition: var(--transition);
        border-radius: 10px;
    }

    .dish:last-child {
        border-bottom: none;
    }

    .dish:hover {
        background: #f1fbf3;
    }

    .dish__main {
        flex: 1;
        min-width: 0;
    }

    .dish__title {
        display: flex;
        align-items: center;
        gap: .5rem;
        font-size: var(--p-size);
        font-weight: 900;
        margin: 0;
        color: var(--text);
        cursor: pointer;
        user-select: none;
    }

    .dish__title:hover {
        color: var(--primary);
    }

    .dish__sub {
        margin: .12rem 0 0;
        color: var(--muted);
        font-size: var(--small-size);
        font-weight: 650;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .2rem .55rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f8fafc;
        color: var(--text);
        font-size: .85rem;
        font-weight: 800;
        white-space: nowrap;
    }

    .tag.star {
        background: #fff7ed;
        border-color: #fed7aa;
    }

    .dish__actions {
        display: flex;
        gap: .5rem;
        flex: 0 0 auto;
    }

    .icon-mini {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text);
        font-weight: 900;
        font-size: var(--small-size);
    }

    .icon-mini:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(2, 6, 23, .08);
    }

    .icon-mini:active {
        transform: translateY(0);
    }

    /* ===== Search Results ===== */
    .search-results {
        display: grid;
        gap: .9rem;
    }

    .result {
        padding: .9rem 1rem;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--card);
        box-shadow: var(--shadow);
        transition: var(--transition);
    }

    .result:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 26px rgba(2, 6, 23, .09);
    }

    .result__top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: .75rem;
    }

    .result__title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 950;
        color: var(--text);
    }

    .result__type {
        font-size: .85rem;
        font-weight: 900;
        color: var(--secondary);
        background: #ecfccb;
        border: 1px solid #d9f99d;
        padding: .18rem .5rem;
        border-radius: 999px;
        white-space: nowrap;
    }

    .result__desc {
        margin: .35rem 0 0;
        color: var(--muted);
        font-size: .95rem;
        font-weight: 650;
    }

    .result__actions {
        margin-top: .65rem;
        display: flex;
        flex-wrap: wrap;
        gap: .6rem;
    }

    .btn-outline {
        appearance: none;
        border: 2px solid var(--primary);
        background: transparent;
        color: var(--primary);
        padding: .55rem .9rem;
        border-radius: 999px;
        font-weight: 900;
        cursor: pointer;
        transition: var(--transition);
        font-size: var(--button-font-size);
    }

    .btn-outline:hover {
        background: var(--primary);
        color: #fff;
        transform: translateY(-1px);
    }

    .btn-outline:active {
        transform: translateY(0);
    }

    /* ===== Recipe View ===== */
    .back-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
        margin-bottom: .9rem;
    }

    .btn-back {
        appearance: none;
        border: 2px solid var(--back-btn-color);
        background: transparent;
        color: var(--back-btn-color);
        padding: .55rem .9rem;
        border-radius: 999px;
        font-weight: 950;
        cursor: pointer;
        transition: var(--transition);
        font-size: var(--button-font-size);
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        white-space: nowrap;
    }

    .btn-back:hover {
        background: var(--back-btn-color);
        color: #fff;
        transform: translateY(-1px);
    }

    .recipe {
        padding: 1rem;
    }

    .recipe__title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 950;
        color: var(--secondary);
        display: flex;
        align-items: center;
        gap: .6rem;
        flex-wrap: wrap;
    }

    .recipe__content {
        margin-top: .8rem;
        padding: .9rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: #fff;
        font-size: var(--p-size);
        line-height: 1.85;
        white-space: pre-wrap;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    .recipe__content.edit-mode {
        background: #f6fdf4;
        border: 2px solid var(--primary-light);
        padding: 1.1rem;
        min-height: 280px;
        border-radius: var(--radius);
        outline: none;
        cursor: text;
    }

    .recipe__tools {
        display: flex;
        flex-wrap: wrap;
        gap: .6rem;
        margin-top: .9rem;
    }

    .btn-wide {
        appearance: none;
        border: none;
        background: var(--edit-btn-color);
        color: #fff;
        padding: .85rem 1rem;
        border-radius: 12px;
        font-weight: 950;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow);
        flex: 1 1 220px;
        text-align: center;
        font-size: var(--button-font-size);
    }

    .btn-wide:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
    }

    /* Video block */
    .video {
        margin-top: 1rem;
        padding: .9rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: #f6fdf4;
    }

    .video__top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
        margin-bottom: .6rem;
    }

    .video__title {
        margin: 0;
        font-size: var(--p-size);
        font-weight: 950;
        color: var(--secondary);
    }

    .video__link {
        display: flex;
        align-items: center;
        gap: .5rem;
        flex-wrap: wrap;
        color: var(--text);
        font-weight: 800;
        font-size: var(--small-size);
    }

    .video__link a {
        color: var(--secondary);
        text-decoration: none;
        font-weight: 950;
        border-bottom: 1px dashed rgba(28, 98, 4, .45);
    }

    .video__link a:hover {
        border-bottom-style: solid;
    }

    .video__frame {
        margin-top: .75rem;
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(73, 176, 40, .25);
        background: #000;
        aspect-ratio: 16 / 9;
    }

    .video__frame iframe {
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
    }

    .video__note {
        margin-top: .55rem;
        color: var(--muted);
        font-size: var(--small-size);
        font-weight: 650;
    }

    /* Social Links block */
    .social-links {
        margin-top: 1rem;
        padding: .9rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: #f6fdf4;
    }

    .social-links__top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
        margin-bottom: .6rem;
    }

    .social-links__title {
        margin: 0;
        font-size: var(--p-size);
        font-weight: 950;
        color: var(--secondary);
    }

    .social-links__list {
        display: flex;
        flex-direction: column;
        gap: .8rem;
    }

    .social-link-item {
        display: flex;
        align-items: center;
        gap: .75rem;
        padding: .7rem;
        background: white;
        border-radius: var(--radius);
        border: 1px solid var(--border);
    }

    .social-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }

    .social-icon.youtube { background: #FF0000; }
    .social-icon.tiktok { background: #000000; }
    .social-icon.facebook { background: #1877F2; }
    .social-icon.instagram { background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D); }
    .social-icon.twitter { background: #1DA1F2; }
    .social-icon.other { background: var(--primary); }

    .social-link-content {
        flex: 1;
        min-width: 0;
    }

    .social-link-name {
        margin: 0;
        font-weight: 700;
        color: var(--text);
        font-size: var(--p-size);
    }

    .social-link-url {
        margin: .2rem 0 0;
        color: var(--muted);
        font-size: var(--small-size);
        word-break: break-all;
    }

    .social-link-actions {
        display: flex;
        gap: .4rem;
    }

    .social-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text);
        transition: var(--transition);
    }

    .social-action-btn:hover {
        background: #f1fbf3;
        transform: translateY(-1px);
    }

    /* Empty / helper */
    .empty {
        padding: 1rem;
        border: 1px dashed var(--border);
        border-radius: var(--radius);
        background: #fff;
        color: var(--muted);
        font-weight: 700;
        font-size: var(--p-size);
    }

    /* ===== Settings Sidebar ===== */
    .settings-btn {
        position: fixed;
        left: 1rem;
        bottom: 1rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 99;
        box-shadow: var(--shadow);
        transition: var(--transition);
    }

    .settings-btn:hover {
        transform: scale(1.1);
    }

    .settings-sidebar {
        position: fixed;
        left: -320px;
        top: 0;
        width: 300px;
        height: 100%;
        background: var(--card);
        box-shadow: 2px 0 20px rgba(0,0,0,0.1);
        z-index: 100;
        transition: left 0.3s ease;
        padding: 1.5rem;
        overflow-y: auto;
    }

    .settings-sidebar.open {
        left: 0;
    }

    .settings-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 99;
        display: none;
    }

    .settings-overlay.open {
        display: block;
    }

    .settings-title {
        margin-top: 0;
        color: var(--secondary);
        font-size: var(--h2-size);
    }

    .settings-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .settings-section-title {
        font-size: var(--h3-size);
        color: var(--text);
        margin: 0 0 .8rem 0;
    }

    .color-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: .6rem;
        margin-bottom: 1rem;
    }

    .color-option {
        aspect-ratio: 1;
        border-radius: 8px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: .8rem;
    }

    .color-option:hover {
        transform: scale(1.05);
    }

    .color-option.selected {
        border-color: var(--text);
        transform: scale(1.05);
    }

    .size-control {
        display: flex;
        align-items: center;
        gap: .5rem;
        margin-bottom: .8rem;
    }

    .size-label {
        flex: 1;
        font-weight: 600;
        color: var(--text);
        font-size: var(--small-size);
    }

    .size-value {
        width: 40px;
        text-align: center;
        font-weight: 700;
        color: var(--secondary);
    }

    .size-slider {
        flex: 2;
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: var(--border);
        outline: none;
    }

    .size-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
    }

    .language-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: .5rem;
        margin-bottom: 1rem;
    }

    .lang-btn {
        padding: .6rem .4rem;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        text-align: center;
    }

    .lang-btn:hover {
        background: #f1fbf3;
    }

    .lang-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* ===== Auth Forms ===== */
    .auth-form {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, .55);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(3px);
    }

    .auth-form .form-container {
        background: var(--card);
        padding: 1.4rem;
        border-radius: var(--radius);
        box-shadow: 0 16px 36px rgba(2, 6, 23, .16);
        width: 92%;
        max-width: 440px;
        border: 1px solid var(--border);
        animation: fadeInUp .35s ease-out;
    }

    .auth-form h3 {
        text-align: center;
        margin: 0 0 1rem;
        color: var(--secondary);
        font-weight: 800;
        font-size: var(--h3-size);
    }

    .auth-form .error-message {
        color: #dc2626;
        margin-bottom: 1rem;
        text-align: center;
        font-size: var(--small-size);
    }

    .auth-form .switch-form {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: var(--small-size);
        font-weight: 800;
        display: block;
        margin: .6rem auto 0;
        text-align: center;
        width: 100%;
        padding: .4rem 0;
        transition: var(--transition);
    }

    .auth-form .switch-form:hover {
        color: var(--primary-light);
        text-decoration: underline;
    }

    @media (max-width: 780px) {
        .header__row {
            flex-wrap: wrap;
        }

        .header__title {
            order: 2;
            width: 100%;
            text-align: center;
        }

        .header__left {
            order: 1;
        }

        .header__right {
            order: 3;
            width: 100%;
            justify-content: center;
        }

        .search-wrap {
            padding-bottom: .85rem;
        }

        .settings-btn {
            left: .5rem;
            bottom: .5rem;
        }

        .settings-sidebar {
            width: 85%;
            left: -85%;
        }
        
        .color-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(16px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .category, .dish, .recipe__content, .btn-wide {
        animation: fadeIn .35s ease-out;
    }
    
    /* Link preview styles */
    .link-preview-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
    }
    
    .link-preview-content {
        background: white;
        border-radius: var(--radius);
        width: 90%;
        max-width: 800px;
        height: 80vh;
        display: flex;
        flex-direction: column;
    }
    
    .link-preview-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .link-preview-iframe {
        flex: 1;
        border: none;
        width: 100%;
    }
    
    .copy-link-btn {
        position: relative;
    }
    
    .copy-notification {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: .3rem .6rem;
        border-radius: 6px;
        font-size: .8rem;
        white-space: nowrap;
    }
    </style>
</head>
<body>
    <!-- ===== HEADER ===== -->
    <header class="header">
        <div class="header__row">
            <div class="header__left">
                <button class="btn" id="authButton" type="button">
                    <i class="fas fa-user"></i>
                    <span id="authText">Увійти</span>
                </button>
            </div>

            <h1 class="header__title" id="appTitle">Кулінарна книга</h1>

            <div class="header__right">
                <button class="btn" type="button" id="addCategoryBtn">
                    <i class="fas fa-plus"></i>
                    <span id="addCategoryText">Додати категорію</span>
                </button>
            </div>
        </div>

        <!-- ===== SEARCH ===== -->
        <div class="search-wrap">
            <div class="search" role="search">
                <input
                    class="search__input"
                    id="global-search"
                    type="search"
                    placeholder="Пошук: категорія або страва… (наприклад: борщ, салат, улюблене)"
                    autocomplete="off"
                />
                <button class="search__chip" type="button" aria-label="Очистити пошук" id="clearSearchBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ===== Кнопка настроек ===== -->
    <button class="settings-btn" id="settingsBtn">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- ===== Сайдбар настроек ===== -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-sidebar" id="settingsSidebar">
        <h2 class="settings-title" id="settingsTitle">Налаштування</h2>
        
        <div class="settings-section">
            <h3 class="settings-section-title" id="colorThemeTitle">Кольорова тема</h3>
            <div class="color-grid">
                <div class="color-option selected" data-color="#35da0d" style="background: #35da0d;" title="Зелений">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="color-option" data-color="#3b82f6" style="background: #3b82f6;" title="Синій">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;" title="Фіолетовий">
                    <i class="fas fa-gem"></i>
                </div>
                <div class="color-option" data-color="#ef4444" style="background: #ef4444;" title="Червоний">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="color-option" data-color="#f97316" style="background: #f97316;" title="Помаранчевий">
                    <i class="fas fa-sun"></i>
                </div>
                <div class="color-option" data-color="#0ea5e9" style="background: #0ea5e9;" title="Блакитний">
                    <i class="fas fa-water"></i>
                </div>
                <div class="color-option" data-color="#10b981" style="background: #10b981;" title="Смарагдовий">
                    <i class="fas fa-tree"></i>
                </div>
                <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;" title="Жовтий">
                    <i class="fas fa-star"></i>
                </div>
                <div class="color-option" data-color="#ec4899" style="background: #ec4899;" title="Рожевий">
                    <i class="fas fa-heart"></i>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3 class="settings-section-title" id="textSizeTitle">Розмір тексту</h3>
            <div class="size-control">
                <span class="size-label" id="baseFontLabel">Базовий розмір:</span>
                <span class="size-value" id="baseFontValue">18</span>
                <input type="range" min="14" max="24" value="18" class="size-slider" id="baseFontSlider">
            </div>
            <div class="size-control">
                <span class="size-label" id="buttonSizeLabel">Розмір кнопок:</span>
                <span class="size-value" id="buttonSizeValue">16</span>
                <input type="range" min="12" max="20" value="16" class="size-slider" id="buttonSizeSlider">
            </div>
        </div>
        
        <div class="settings-section">
            <h3 class="settings-section-title" id="languageTitle">Мова</h3>
            <div class="language-selector">
                <button class="lang-btn active" data-lang="uk">
                    <i class="fas fa-language"></i>
                    <span>Українська</span>
                </button>
                <button class="lang-btn" data-lang="en">
                    <i class="fas fa-language"></i>
                    <span>English</span>
                </button>
                <button class="lang-btn" data-lang="hy">
                    <i class="fas fa-language"></i>
                    <span>Հայերեն</span>
                </button>
            </div>
        </div>
        
        <button class="btn-long" onclick="saveSettings()" id="saveSettingsBtn">
            <i class="fas fa-save"></i>
            <span>Зберегти налаштування</span>
        </button>
    </div>

    <!-- ===== Main Content ===== -->
    <main class="main">
        <!-- ===== SCREEN: MAIN (категорії) ===== -->
        <section class="screen is-active" id="screen-main">
            <h2 class="section-title" id="categoriesTitle">Категорії страв</h2>

            <!-- Search Results -->
            <div class="search-results" id="search-results" style="display:none;"></div>

            <!-- ===== CATEGORIES LIST ===== -->
            <div id="categories">
                <!-- Категорії будуть додані через JS -->
                <div class="empty" id="empty-categories" style="display: none;">
                    <i class="fas fa-utensils"></i>
                    <p id="emptyCategoriesText">Поки що немає категорій. Натисніть "Додати категорію".</p>
                </div>
            </div>
        </section>

        <!-- ===== SCREEN: ADD CATEGORY ===== -->
        <section class="screen" id="screen-add">
            <div class="back-row">
                <button class="btn-back" type="button" id="backFromAddBtn">
                    <i class="fas fa-arrow-left"></i>
                    <span id="backText">Назад</span>
                </button>
                <span class="hint" id="addCategoryHint">Додаємо категорію</span>
            </div>

            <h2 class="section-title" id="addCategoryTitle">Додати категорію</h2>

            <div class="card" style="padding: 1rem;">
                <label class="hint" for="new-category-name" id="categoryNameLabel">Назва категорії</label>
                <input
                    id="new-category-name"
                    type="text"
                    placeholder="Наприклад: Салати"
                    style="width:100%;margin:.35rem 0 .8rem;padding:.85rem 1rem;border:1px solid var(--border);border-radius:14px;font-size:1rem;font-weight:650;"
                />
                <button class="btn-wide" type="button" id="addCategoryConfirmBtn">
                    <i class="fas fa-plus"></i>
                    <span id="addConfirmText">Додати</span>
                </button>
            </div>
        </section>

        <!-- ===== SCREEN: RECIPE VIEW ===== -->
        <section class="screen" id="screen-recipe">
            <div class="back-row">
                <button class="btn-back" type="button" id="backFromRecipeBtn">
                    <i class="fas fa-arrow-left"></i>
                    <span id="backText2">Назад</span>
                </button>
                <div class="tag star" id="favorite-tag" style="display: none;">
                    <i class="fas fa-star"></i>
                    <span id="favoriteText">Улюблене</span>
                </div>
            </div>

            <article class="card recipe">
                <h2 class="recipe__title" id="recipe-title">
                    <span id="recipe-name">Назва страви</span>
                    <span class="tag" id="recipe-category-tag">
                        <i class="fas fa-folder"></i>
                        <span id="categoryText">Категорія: ...</span>
                    </span>
                </h2>

                <div class="recipe__content" id="recipe-display" contenteditable="false">
                    Текст рецепту...
                </div>

                <div class="recipe__tools" id="recipe-tools" style="display: none;">
                    <button class="btn-wide" type="button" id="saveRecipeBtn">
                        <i class="fas fa-save"></i>
                        <span id="saveText">Зберегти</span>
                    </button>
                    <button class="btn-wide" type="button" id="cancelEditBtn" style="background: #fff; color: var(--edit-btn-color); border: 2px solid var(--edit-btn-color); box-shadow: none;">
                        <i class="fas fa-times"></i>
                        <span id="cancelText">Скасувати</span>
                    </button>
                </div>

                <button class="btn-wide" type="button" id="editRecipeBtn">
                    <i class="fas fa-edit"></i>
                    <span id="editText">Редагувати</span>
                </button>

                <!-- ===== VIDEO ===== -->
                <div class="video" id="video-block" style="display: none;">
                    <div class="video__top">
                        <p class="video__title">
                            <i class="fas fa-video"></i>
                            <span id="videoTitle">Відео</span>
                        </p>
                        <button class="btn-outline" type="button" id="addVideoBtn">
                            <i class="fas fa-plus"></i>
                            <span id="addVideoText">Додати посилання</span>
                        </button>
                    </div>

                    <div class="video__link" id="video-link" style="display: none;">
                        <span id="linkText">Посилання:</span>
                        <a href="#" target="_blank" rel="noopener noreferrer" id="video-url">https://youtu.be/xxxxxxx</a>
                    </div>

                    <div class="video__frame" id="video-frame" style="display: none;">
                        <iframe
                            title="YouTube відео"
                            src=""
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen
                            id="video-iframe"
                        ></iframe>
                    </div>

                    <div class="video__note">
                        <i class="fas fa-lightbulb"></i>
                        <span id="videoNote">Порада: можна зберігати звичайне посилання на YouTube — я покажу кнопку для перегляду і (за бажанням) вбудую відео.</span>
                    </div>
                </div>

                <!-- ===== SOCIAL LINKS ===== -->
                <div class="social-links" id="social-links-block" style="display: none;">
                    <div class="social-links__top">
                        <p class="social-links__title">
                            <i class="fas fa-share-alt"></i>
                            <span id="socialLinksTitle">Соціальні посилання</span>
                        </p>
                        <button class="btn-outline" type="button" id="addSocialLinkBtn">
                            <i class="fas fa-plus"></i>
                            <span id="addSocialLinkText">Додати посилання</span>
                        </button>
                    </div>

                    <div class="social-links__list" id="social-links-list">
                        <!-- Социальные ссылки будут добавляться здесь -->
                    </div>
                </div>
            </article>
        </section>
    </main>

    <!-- ===== Auth Forms ===== -->
    <div id="auth-menu" class="auth-form" style="display: none">
        <div class="form-container">
            <div id="login-form">
                <h3 id="loginTitle">Увійти</h3>
                <div id="login-error" class="error-message"></div>
                <input type="email" id="login-email" placeholder="Email" style="width:100%;padding:.8rem 1rem;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:.8rem;font-size:1rem;" />
                <input type="password" id="login-password" placeholder="Пароль" style="width:100%;padding:.8rem 1rem;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:1rem;font-size:1rem;" />
                <button class="btn-wide" onclick="login()" style="width:100%;">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="loginBtnText">Увійти</span>
                </button>
                <button class="switch-form" onclick="showRegisterForm()" id="registerSwitchText">
                    <i class="fas fa-user-plus"></i>
                    <span>Зареєструватися</span>
                </button>
            </div>
            <div id="register-form" style="display: none">
                <h3 id="registerTitle">Реєстрація</h3>
                <div id="register-error" class="error-message"></div>
                <input type="text" id="register-name" placeholder="Ім'я" style="width:100%;padding:.8rem 1rem;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:.8rem;font-size:1rem;" />
                <input type="email" id="register-email" placeholder="Email" style="width:100%;padding:.8rem 1rem;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:.8rem;font-size:1rem;" />
                <input type="password" id="register-password" placeholder="Пароль" style="width:100%;padding:.8rem 1rem;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:.8rem;font-size:1rem;" />
                <input type="password" id="register-confirm-password" placeholder="Підтвердіть пароль" style="width:100%;padding:.8rem 1rem;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:1rem;font-size:1rem;" />
                <button class="btn-wide" onclick="register()" style="width:100%;">
                    <i class="fas fa-user-plus"></i>
                    <span id="registerBtnText">Зареєструватися</span>
                </button>
                <button class="switch-form" onclick="showLoginForm()" id="loginSwitchText">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Вже маєте акаунт? Увійти</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== Link Preview Modal ===== -->
    <div class="link-preview-modal" id="linkPreviewModal" style="display: none;">
        <div class="link-preview-content">
            <div class="link-preview-header">
                <h3 style="margin: 0;" id="previewTitle">Перегляд посилання</h3>
                <button class="btn" onclick="closeLinkPreview()">
                    <i class="fas fa-times"></i>
                    <span id="closePreviewText">Закрити</span>
                </button>
            </div>
            <iframe class="link-preview-iframe" id="linkPreviewIframe"></iframe>
        </div>
    </div>

    <script>
    // ==================== КОНФИГУРАЦИЯ FIREBASE ====================
    const firebaseConfig = {
        apiKey: "AIzaSyCsi129Y9ltNjMbNPU8D9s1JURMxVyeHYs",
        authDomain: "notebook-66f4e.firebaseapp.com",
        databaseURL: "https://notebook-66f4e-default-rtdb.firebaseio.com",
        projectId: "notebook-66f4e",
        storageBucket: "notebook-66f4e.appspot.com",
        messagingSenderId: "1234567890",
        appId: "1:1234567890:web:abcdef1234567890",
    };

    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Глобальные переменные
    let currentUser = null;
    let currentCat = null;
    let currentDish = null;
    
    // Переменные для поиска
    let searchCache = {
        categories: {},
        flatCats: [],
        flatDishes: []
    };
    let debounceTimer = null;

    // Текущий язык
    let currentLanguage = 'uk';
    
    // Локализация
    const translations = {
        uk: {
            // Заголовки
            appTitle: "Кулінарна книга",
            categoriesTitle: "Категорії страв",
            addCategoryTitle: "Додати категорію",
            
            // Кнопки
            authText: "Увійти",
            logoutText: "Вийти",
            addCategoryText: "Додати категорію",
            backText: "Назад",
            addConfirmText: "Додати",
            editText: "Редагувати",
            saveText: "Зберегти",
            cancelText: "Скасувати",
            favoriteText: "Улюблене",
            categoryText: "Категорія: ",
            
            // Подсказки
            addCategoryHint: "Додаємо категорію",
            categoryNameLabel: "Назва категорії",
            emptyCategoriesText: "Поки що немає категорій. Натисніть \"Додати категорію\".",
            
            // Видео
            videoTitle: "Відео",
            addVideoText: "Додати посилання",
            linkText: "Посилання:",
            videoNote: "Порада: можна зберігати звичайне посилання на YouTube — я покажу кнопку для перегляду і (за бажанням) вбудую відео.",
            
            // Соцсети
            socialLinksTitle: "Соціальні посилання",
            addSocialLinkText: "Додати посилання",
            copyLinkText: "Копіювати",
            viewLinkText: "Перегляд",
            deleteLinkText: "Видалити",
            
            // Настройки
            settingsTitle: "Налаштування",
            colorThemeTitle: "Кольорова тема",
            textSizeTitle: "Розмір тексту",
            baseFontLabel: "Базовий розмір:",
            buttonSizeLabel: "Розмір кнопок:",
            languageTitle: "Мова",
            saveSettingsBtn: "Зберегти налаштування",
            
            // Авторизация
            loginTitle: "Увійти",
            loginBtnText: "Увійти",
            registerTitle: "Реєстрація",
            registerBtnText: "Зареєструватися",
            registerSwitchText: "Зареєструватися",
            loginSwitchText: "Вже маєте акаунт? Увійти",
            
            // Предпросмотр
            previewTitle: "Перегляд посилання",
            closePreviewText: "Закрити",
            
            // Поиск
            searchPlaceholder: "Пошук: категорія або страва… (наприклад: борщ, салат, улюблене)",
            
            // Алerts
            confirmDeleteCategory: "Видалити категорію разом з усіма стравами?",
            confirmDeleteDish: "Видалити страву?",
            confirmDeleteLink: "Видалити посилання?",
            enterCategoryName: "Введіть назву категорії",
            enterDishName: "Назва страви:",
            enterVideoUrl: "Вставте посилання на відео (YouTube):",
            enterSocialUrl: "Вставте посилання на соціальну мережу:",
            selectPlatform: "Виберіть платформу:",
            linkCopied: "Посилання скопійовано!",
            noAccountAlert: "Спочатку увійдіть у свій акаунт."
        },
        en: {
            appTitle: "Cookbook",
            categoriesTitle: "Dish Categories",
            addCategoryTitle: "Add Category",
            
            authText: "Login",
            logoutText: "Logout",
            addCategoryText: "Add Category",
            backText: "Back",
            addConfirmText: "Add",
            editText: "Edit",
            saveText: "Save",
            cancelText: "Cancel",
            favoriteText: "Favorite",
            categoryText: "Category: ",
            
            addCategoryHint: "Adding category",
            categoryNameLabel: "Category name",
            emptyCategoriesText: "No categories yet. Click \"Add Category\".",
            
            videoTitle: "Video",
            addVideoText: "Add link",
            linkText: "Link:",
            videoNote: "Tip: you can save a regular YouTube link - I'll show a button to view and (optional) embed the video.",
            
            socialLinksTitle: "Social Links",
            addSocialLinkText: "Add link",
            copyLinkText: "Copy",
            viewLinkText: "View",
            deleteLinkText: "Delete",
            
            settingsTitle: "Settings",
            colorThemeTitle: "Color Theme",
            textSizeTitle: "Text Size",
            baseFontLabel: "Base size:",
            buttonSizeLabel: "Button size:",
            languageTitle: "Language",
            saveSettingsBtn: "Save Settings",
            
            loginTitle: "Login",
            loginBtnText: "Login",
            registerTitle: "Registration",
            registerBtnText: "Register",
            registerSwitchText: "Register",
            loginSwitchText: "Already have an account? Login",
            
            previewTitle: "Link Preview",
            closePreviewText: "Close",
            
            searchPlaceholder: "Search: category or dish… (for example: borscht, salad, favorite)",
            
            confirmDeleteCategory: "Delete category with all dishes?",
            confirmDeleteDish: "Delete dish?",
            confirmDeleteLink: "Delete link?",
            enterCategoryName: "Enter category name",
            enterDishName: "Dish name:",
            enterVideoUrl: "Paste video link (YouTube):",
            enterSocialUrl: "Paste social media link:",
            selectPlatform: "Select platform:",
            linkCopied: "Link copied!",
            noAccountAlert: "Please log in to your account first."
        },
        hy: {
            appTitle: "Խոհարարական գիրք",
            categoriesTitle: "Ուտեստների կատեգորիաներ",
            addCategoryTitle: "Ավելացնել կատեգորիա",
            
            authText: "Մուտք",
            logoutText: "Ելք",
            addCategoryText: "Ավելացնել կատեգորիա",
            backText: "Հետ",
            addConfirmText: "Ավելացնել",
            editText: "Խմբագրել",
            saveText: "Պահպանել",
            cancelText: "Չեղարկել",
            favoriteText: "Սիրված",
            categoryText: "Կատեգորիա: ",
            
            addCategoryHint: "Ավելացնում ենք կատեգորիա",
            categoryNameLabel: "Կատեգորիայի անվանումը",
            emptyCategoriesText: "Դեռ կատեգորիաներ չկան: Սեղմեք \"Ավելացնել կատեգորիա\".",
            
            videoTitle: "Տեսանյութ",
            addVideoText: "Ավելացնել հղում",
            linkText: "Հղում:",
            videoNote: "Հուշում: կարող եք պահել սովորական YouTube հղումը - ես ցույց կտամ դիտելու կոճակը և (ըստ ցանկության) ներդնել տեսանյութը:",
            
            socialLinksTitle: "Սոցիալական հղումներ",
            addSocialLinkText: "Ավելացնել հղում",
            copyLinkText: "Պատճենել",
            viewLinkText: "Դիտել",
            deleteLinkText: "Ջնջել",
            
            settingsTitle: "Կարգավորումներ",
            colorThemeTitle: "Գույնի թեմա",
            textSizeTitle: "Տեքստի չափը",
            baseFontLabel: "Հիմնական չափը:",
            buttonSizeLabel: "Կոճակների չափը:",
            languageTitle: "Լեզու",
            saveSettingsBtn: "Պահպանել կարգավորումները",
            
            loginTitle: "Մուտք",
            loginBtnText: "Մուտք",
            registerTitle: "Գրանցում",
            registerBtnText: "Գրանցվել",
            registerSwitchText: "Գրանցվել",
            loginSwitchText: "Արդեն ունեք հաշիվ: Մուտք",
            
            previewTitle: "Հղման նախադիտում",
            closePreviewText: "Փակել",
            
            searchPlaceholder: "Որոնում: կատեգորիա կամ ուտեստ… (օրինակ՝ բորշչ, աղցան, սիրված)",
            
            confirmDeleteCategory: "Ջնջել կատեգորիան բոլոր ուտեստներով միասին:",
            confirmDeleteDish: "Ջնջել ուտեստը:",
            confirmDeleteLink: "Ջնջել հղումը:",
            enterCategoryName: "Մուտքագրեք կատեգորիայի անվանումը",
            enterDishName: "Ուտեստի անվանումը:",
            enterVideoUrl: "Կպցրեք տեսանյութի հղումը (YouTube):",
            enterSocialUrl: "Կպցրեք սոցիալական ցանցի հղումը:",
            selectPlatform: "Ընտրեք հարթակը:",
            linkCopied: "Հղումը պատճենվել է:",
            noAccountAlert: "Նախ մուտք գործեք ձեր հաշիվ:"
        }
    };

    // ==================== ЛОКАЛИЗАЦИЯ ====================
    function setLanguage(lang) {
        currentLanguage = lang;
        document.getElementById('html-lang').lang = lang;
        
        // Обновляем все текстовые элементы
        const t = translations[lang];
        
        // Заголовки
        document.getElementById('appTitle').textContent = t.appTitle;
        document.getElementById('page-title').textContent = t.appTitle;
        document.getElementById('categoriesTitle').textContent = t.categoriesTitle;
        document.getElementById('addCategoryTitle').textContent = t.addCategoryTitle;
        
        // Кнопки
        if (currentUser) {
            document.getElementById('authText').textContent = t.logoutText;
        } else {
            document.getElementById('authText').textContent = t.authText;
        }
        document.getElementById('addCategoryText').textContent = t.addCategoryText;
        document.getElementById('backText').textContent = t.backText;
        document.getElementById('backText2').textContent = t.backText;
        document.getElementById('addConfirmText').textContent = t.addConfirmText;
        document.getElementById('editText').textContent = t.editText;
        document.getElementById('saveText').textContent = t.saveText;
        document.getElementById('cancelText').textContent = t.cancelText;
        document.getElementById('favoriteText').textContent = t.favoriteText;
        
        // Тексты
        document.getElementById('categoryText').textContent = t.categoryText;
        document.getElementById('addCategoryHint').textContent = t.addCategoryHint;
        document.getElementById('categoryNameLabel').textContent = t.categoryNameLabel;
        document.getElementById('emptyCategoriesText').textContent = t.emptyCategoriesText;
        
        // Видео
        document.getElementById('videoTitle').textContent = t.videoTitle;
        document.getElementById('addVideoText').textContent = t.addVideoText;
        document.getElementById('linkText').textContent = t.linkText;
        document.getElementById('videoNote').textContent = t.videoNote;
        
        // Соцсети
        document.getElementById('socialLinksTitle').textContent = t.socialLinksTitle;
        document.getElementById('addSocialLinkText').textContent = t.addSocialLinkText;
        
        // Настройки
        document.getElementById('settingsTitle').textContent = t.settingsTitle;
        document.getElementById('colorThemeTitle').textContent = t.colorThemeTitle;
        document.getElementById('textSizeTitle').textContent = t.textSizeTitle;
        document.getElementById('baseFontLabel').textContent = t.baseFontLabel;
        document.getElementById('buttonSizeLabel').textContent = t.buttonSizeLabel;
        document.getElementById('languageTitle').textContent = t.languageTitle;
        document.getElementById('saveSettingsBtn').textContent = t.saveSettingsBtn;
        
        // Авторизация
        document.getElementById('loginTitle').textContent = t.loginTitle;
        document.getElementById('loginBtnText').textContent = t.loginBtnText;
        document.getElementById('registerTitle').textContent = t.registerTitle;
        document.getElementById('registerBtnText').textContent = t.registerBtnText;
        document.getElementById('registerSwitchText').textContent = t.registerSwitchText;
        document.getElementById('loginSwitchText').textContent = t.loginSwitchText;
        
        // Предпросмотр
        document.getElementById('previewTitle').textContent = t.previewTitle;
        document.getElementById('closePreviewText').textContent = t.closePreviewText;
        
        // Поиск
        document.getElementById('global-search').placeholder = t.searchPlaceholder;
        
        // Обновляем активную кнопку языка
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-lang') === lang) {
                btn.classList.add('active');
            }
        });
        
        // Сохраняем язык в localStorage
        localStorage.setItem('preferredLanguage', lang);
    }

    // ==================== НАСТРОЙКИ ====================
    function loadSettings() {
        // Цвета
        const savedHeaderColor = localStorage.getItem('headerColor');
        const savedEditBtnColor = localStorage.getItem('editBtnColor');
        const savedBackBtnColor = localStorage.getItem('backBtnColor');
        
        if (savedHeaderColor) {
            document.documentElement.style.setProperty('--header-color', savedHeaderColor);
            document.documentElement.style.setProperty('--primary', savedHeaderColor);
            // Выделяем выбранный цвет
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-color') === savedHeaderColor) {
                    option.classList.add('selected');
                }
            });
        }
        
        // Размеры шрифтов
        const savedBaseFont = localStorage.getItem('baseFontSize');
        const savedButtonFont = localStorage.getItem('buttonFontSize');
        
        if (savedBaseFont) {
            document.documentElement.style.setProperty('--base-font-size', savedBaseFont + 'px');
            document.getElementById('baseFontSlider').value = savedBaseFont;
            document.getElementById('baseFontValue').textContent = savedBaseFont;
            
            // Обновляем остальные размеры пропорционально
            const baseSize = parseInt(savedBaseFont);
            document.documentElement.style.setProperty('--h1-size', (baseSize * 1.55 / 18) + 'rem');
            document.documentElement.style.setProperty('--h2-size', (baseSize * 1.25 / 18) + 'rem');
            document.documentElement.style.setProperty('--h3-size', (baseSize * 1.1 / 18) + 'rem');
            document.documentElement.style.setProperty('--p-size', (baseSize * 1 / 18) + 'rem');
            document.documentElement.style.setProperty('--small-size', (baseSize * 0.92 / 18) + 'rem');
        }
        
        if (savedButtonFont) {
            document.documentElement.style.setProperty('--button-font-size', savedButtonFont + 'px');
            document.getElementById('buttonSizeSlider').value = savedButtonFont;
            document.getElementById('buttonSizeValue').textContent = savedButtonFont;
            
            // Обновляем padding кнопок пропорционально
            const buttonSize = parseInt(savedButtonFont);
            const paddingVertical = (buttonSize * 0.58 / 16) + 'rem';
            const paddingHorizontal = (buttonSize * 0.9 / 16) + 'rem';
            document.documentElement.style.setProperty('--button-padding', `${paddingVertical} ${paddingHorizontal}`);
        }
        
        // Язык
        const savedLanguage = localStorage.getItem('preferredLanguage');
        if (savedLanguage && translations[savedLanguage]) {
            setLanguage(savedLanguage);
        }
    }

    function saveSettings() {
        // Сохраняем цвет
        const selectedColor = document.querySelector('.color-option.selected');
        if (selectedColor) {
            const color = selectedColor.getAttribute('data-color');
            localStorage.setItem('headerColor', color);
            localStorage.setItem('editBtnColor', color);
            localStorage.setItem('backBtnColor', color);
            
            document.documentElement.style.setProperty('--header-color', color);
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--edit-btn-color', color);
            document.documentElement.style.setProperty('--back-btn-color', color);
            document.documentElement.style.setProperty('--accent', color);
            
            // Для вторичного цвета делаем темнее
            const darkerColor = shadeColor(color, -30);
            document.documentElement.style.setProperty('--secondary', darkerColor);
        }
        
        // Сохраняем размеры
        const baseFontSize = document.getElementById('baseFontSlider').value;
        const buttonFontSize = document.getElementById('buttonSizeSlider').value;
        
        localStorage.setItem('baseFontSize', baseFontSize);
        localStorage.setItem('buttonFontSize', buttonFontSize);
        
        // Применяем размеры
        document.documentElement.style.setProperty('--base-font-size', baseFontSize + 'px');
        document.documentElement.style.setProperty('--button-font-size', buttonFontSize + 'px');
        
        // Обновляем остальные размеры пропорционально
        const baseSize = parseInt(baseFontSize);
        document.documentElement.style.setProperty('--h1-size', (baseSize * 1.55 / 18) + 'rem');
        document.documentElement.style.setProperty('--h2-size', (baseSize * 1.25 / 18) + 'rem');
        document.documentElement.style.setProperty('--h3-size', (baseSize * 1.1 / 18) + 'rem');
        document.documentElement.style.setProperty('--p-size', (baseSize * 1 / 18) + 'rem');
        document.documentElement.style.setProperty('--small-size', (baseSize * 0.92 / 18) + 'rem');
        
        // Обновляем padding кнопок
        const buttonSize = parseInt(buttonFontSize);
        const paddingVertical = (buttonSize * 0.58 / 16) + 'rem';
        const paddingHorizontal = (buttonSize * 0.9 / 16) + 'rem';
        document.documentElement.style.setProperty('--button-padding', `${paddingVertical} ${paddingHorizontal}`);
        
        closeSettings();
        showNotification(translations[currentLanguage].saveText + "!");
    }

    // Функция для затемнения цвета
    function shadeColor(color, percent) {
        let R = parseInt(color.substring(1,3),16);
        let G = parseInt(color.substring(3,5),16);
        let B = parseInt(color.substring(5,7),16);

        R = parseInt(R * (100 + percent) / 100);
        G = parseInt(G * (100 + percent) / 100);
        B = parseInt(B * (100 + percent) / 100);

        R = (R<255)?R:255;  
        G = (G<255)?G:255;  
        B = (B<255)?B:255;  

        R = Math.round(R);
        G = Math.round(G);
        B = Math.round(B);

        const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
        const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
        const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

        return "#"+RR+GG+BB;
    }

    function initSettings() {
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const settingsSidebar = document.getElementById('settingsSidebar');
        
        settingsBtn.addEventListener('click', () => {
            settingsSidebar.classList.add('open');
            settingsOverlay.classList.add('open');
        });
        
        settingsOverlay.addEventListener('click', closeSettings);
        
        // Обработчики слайдеров
        document.getElementById('baseFontSlider').addEventListener('input', function() {
            document.getElementById('baseFontValue').textContent = this.value;
        });
        
        document.getElementById('buttonSizeSlider').addEventListener('input', function() {
            document.getElementById('buttonSizeValue').textContent = this.value;
        });
        
        // Обработчики цветов
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
        
        // Обработчики языка
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const lang = this.getAttribute('data-lang');
                setLanguage(lang);
            });
        });
    }

    function closeSettings() {
        document.getElementById('settingsSidebar').classList.remove('open');
        document.getElementById('settingsOverlay').classList.remove('open');
    }

    // ==================== СОЦИАЛЬНЫЕ ССЫЛКИ ====================
    function addSocialLink() {
        if (!currentCat || !currentDish) return;
        
        const platforms = [
            { name: 'YouTube', value: 'youtube', icon: 'fab fa-youtube' },
            { name: 'TikTok', value: 'tiktok', icon: 'fab fa-tiktok' },
            { name: 'Facebook', value: 'facebook', icon: 'fab fa-facebook' },
            { name: 'Instagram', value: 'instagram', icon: 'fab fa-instagram' },
            { name: 'Twitter/X', value: 'twitter', icon: 'fab fa-twitter' },
            { name: 'Другое', value: 'other', icon: 'fas fa-link' }
        ];
        
        const platformOptions = platforms.map(p => 
            `<option value="${p.value}">${p.name}</option>`
        ).join('');
        
        const html = `
            <div>
                <label style="display:block; margin-bottom: 8px; font-weight: 600;">${translations[currentLanguage].selectPlatform}</label>
                <select id="social-platform" style="width:100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border);">
                    ${platformOptions}
                </select>
                <label style="display:block; margin-bottom: 8px; font-weight: 600;">URL:</label>
                <input type="text" id="social-url" placeholder="https://..." style="width:100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
            </div>
        `;
        
        const result = showCustomPrompt(translations[currentLanguage].enterSocialUrl, html);
        if (!result) return;
        
        const platform = document.getElementById('social-platform').value;
        const url = document.getElementById('social-url').value.trim();
        
        if (!url) return;
        
        const linkId = db.ref().push().key;
        const linkData = {
            platform: platform,
            url: url,
            name: platforms.find(p => p.value === platform)?.name || 'Link'
        };
        
        db.ref(`users/${currentUser.uid}/categories/${currentCat}/dishes/${currentDish}/socialLinks/${linkId}`)
            .set(linkData)
            .then(() => {
                loadSocialLinks(currentCat, currentDish);
            });
    }

    function loadSocialLinks(catId, dishId) {
        if (!currentUser) return;
        
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}/socialLinks`)
            .once("value")
            .then((snap) => {
                const links = snap.val() || {};
                renderSocialLinks(links);
            });
    }

    function renderSocialLinks(links) {
        const container = document.getElementById('social-links-list');
        const block = document.getElementById('social-links-block');
        
        if (Object.keys(links).length === 0) {
            block.style.display = 'none';
            return;
        }
        
        block.style.display = 'block';
        container.innerHTML = '';
        
        const t = translations[currentLanguage];
        
        Object.entries(links).forEach(([linkId, link]) => {
            const platformIcons = {
                youtube: 'fab fa-youtube',
                tiktok: 'fab fa-tiktok',
                facebook: 'fab fa-facebook',
                instagram: 'fab fa-instagram',
                twitter: 'fab fa-twitter',
                other: 'fas fa-link'
            };
            
            const platformColors = {
                youtube: '#FF0000',
                tiktok: '#000000',
                facebook: '#1877F2',
                instagram: 'linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D)',
                twitter: '#1DA1F2',
                other: 'var(--primary)'
            };
            
            const linkEl = document.createElement('div');
            linkEl.className = 'social-link-item';
            linkEl.innerHTML = `
                <div class="social-icon ${link.platform}" style="background: ${platformColors[link.platform] || 'var(--primary)'};">
                    <i class="${platformIcons[link.platform] || 'fas fa-link'}"></i>
                </div>
                <div class="social-link-content">
                    <p class="social-link-name">${escapeHtml(link.name)}</p>
                    <p class="social-link-url">${escapeHtml(link.url)}</p>
                </div>
                <div class="social-link-actions">
                    <button class="social-action-btn copy-link-btn" onclick="copyToClipboard('${escapeHtml(link.url)}')" title="${t.copyLinkText}">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="social-action-btn" onclick="previewLink('${escapeHtml(link.url)}')" title="${t.viewLinkText}">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    <button class="social-action-btn" onclick="deleteSocialLink('${linkId}')" title="${t.deleteLinkText}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(linkEl);
        });
    }

    function deleteSocialLink(linkId) {
        if (!confirm(translations[currentLanguage].confirmDeleteLink)) return;
        
        db.ref(`users/${currentUser.uid}/categories/${currentCat}/dishes/${currentDish}/socialLinks/${linkId}`)
            .remove()
            .then(() => {
                loadSocialLinks(currentCat, currentDish);
            });
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification(translations[currentLanguage].linkCopied);
        });
    }

    function previewLink(url) {
        document.getElementById('linkPreviewIframe').src = url;
        document.getElementById('linkPreviewModal').style.display = 'flex';
    }

    function closeLinkPreview() {
        document.getElementById('linkPreviewModal').style.display = 'none';
        document.getElementById('linkPreviewIframe').src = '';
    }

    // ==================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====================
    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text || "";
        return div.innerHTML;
    }

    function norm(s) {
        return (s || "").toString().trim().toLowerCase();
    }

    function includesLoose(hay, needle) {
        hay = norm(hay);
        needle = norm(needle);
        if (!hay || !needle) return false;
        return hay.includes(needle) || needle.includes(hay);
    }

    function showScreen(id) {
        const screens = ["screen-main", "screen-add", "screen-recipe"];
        screens.forEach(screenId => {
            const el = document.getElementById(screenId);
            if (el) {
                el.style.display = screenId === id ? "block" : "none";
                if (el.classList) {
                    if (screenId === id) {
                        el.classList.add("is-active");
                    } else {
                        el.classList.remove("is-active");
                    }
                }
            }
        });
    }

    function showNotification(message) {
        // Создаем уведомление
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 1002;
            animation: slideIn 0.3s ease;
            font-weight: 600;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Удаляем через 3 секунды
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    function showCustomPrompt(title, htmlContent) {
        return new Promise((resolve) => {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: var(--radius);
                width: 90%;
                max-width: 400px;
                box-shadow: var(--shadow);
            `;
            
            modal.innerHTML = `
                <h3 style="margin-top: 0; margin-bottom: 15px;">${title}</h3>
                ${htmlContent}
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="customPromptOk" style="flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        OK
                    </button>
                    <button id="customPromptCancel" style="flex: 1; padding: 10px; background: #f1f5f9; color: var(--text); border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ${translations[currentLanguage].cancelText}
                    </button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            document.getElementById('customPromptOk').onclick = () => {
                document.body.removeChild(overlay);
                resolve(true);
            };
            
            document.getElementById('customPromptCancel').onclick = () => {
                document.body.removeChild(overlay);
                resolve(false);
            };
        });
    }

    // Добавляем CSS для анимаций уведомлений
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // ==================== АУТЕНТИФИКАЦИЯ ====================
    function toggleAuthMenu() {
        if (currentUser) {
            if (confirm(translations[currentLanguage].logoutText + "?")) {
                auth.signOut();
            }
        } else {
            document.getElementById("auth-menu").style.display = "flex";
            showLoginForm();
        }
    }

    function showLoginForm() {
        document.getElementById("login-form").style.display = "block";
        document.getElementById("register-form").style.display = "none";
        document.getElementById("login-error").textContent = "";
    }

    function showRegisterForm() {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("register-form").style.display = "block";
        document.getElementById("register-error").textContent = "";
    }

    function hideAuthMenu() {
        document.getElementById("auth-menu").style.display = "none";
    }

    function login() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const error = document.getElementById("login-error");
        
        auth.signInWithEmailAndPassword(email, password)
            .catch((err) => {
                error.textContent = err.message;
            });
    }

    function register() {
        const name = document.getElementById("register-name").value.trim();
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;
        const confirm = document.getElementById("register-confirm-password").value;
        const error = document.getElementById("register-error");
        
        if (password !== confirm) {
            error.textContent = translations[currentLanguage].passwordsNotMatch || "Паролі не співпадають";
            return;
        }
        
        auth.createUserWithEmailAndPassword(email, password)
            .then((cred) => {
                return db.ref(`users/${cred.user.uid}/profile`).set({ name, email });
            })
            .then(() => {
                hideAuthMenu();
            })
            .catch((err) => {
                error.textContent = err.message;
            });
    }

    // Слушатель изменения состояния аутентификации
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            hideAuthMenu();
            loadCategories();
            document.getElementById("authText").textContent = translations[currentLanguage].logoutText;
        } else {
            currentUser = null;
            document.getElementById("categories").innerHTML = "";
            document.getElementById("authText").textContent = translations[currentLanguage].authText;
            showScreen("screen-main");
        }
    });

    // ==================== КАТЕГОРИИ ====================
    function loadCategories() {
        if (!currentUser) return;
        
        db.ref(`users/${currentUser.uid}/categories`)
            .once("value")
            .then((snap) => {
                const data = snap.val() || {};
                rebuildSearchCache(data);
                renderCategories(data);
            });
    }

    function rebuildSearchCache(data) {
        searchCache.categories = data || {};
        searchCache.flatCats = [];
        searchCache.flatDishes = [];
        
        for (const [catId, cat] of Object.entries(searchCache.categories)) {
            const catName = cat?.name || "";
            const dishesObj = cat?.dishes || {};
            const dishEntries = Object.entries(dishesObj);
            
            // Сортируем блюда: сначала избранные
            const sortedDishes = dishEntries.sort((a, b) => {
                const aFavorite = !!a[1]?.favorite;
                const bFavorite = !!b[1]?.favorite;
                if (aFavorite && !bFavorite) return -1;
                if (!aFavorite && bFavorite) return 1;
                return 0;
            });
            
            searchCache.flatCats.push({
                catId,
                name: catName,
                dishesCount: dishEntries.length,
                hasFavorites: sortedDishes.some(([_, dish]) => dish?.favorite)
            });
            
            for (const [dishId, dish] of sortedDishes) {
                searchCache.flatDishes.push({
                    catId,
                    catName,
                    dishId,
                    name: dish?.name || "",
                    description: dish?.description || "",
                    favorite: !!dish?.favorite,
                    videoUrl: dish?.videoUrl || ""
                });
            }
        }
        
        // Сортируем категории: сначала те, где есть избранные
        searchCache.flatCats.sort((a, b) => {
            if (a.hasFavorites && !b.hasFavorites) return -1;
            if (!a.hasFavorites && b.hasFavorites) return 1;
            return a.name.localeCompare(b.name);
        });
    }

    function renderCategories(categories) {
        const container = document.getElementById("categories");
        const emptyEl = document.getElementById("empty-categories");
        
        container.innerHTML = "";
        
        if (Object.keys(categories).length === 0) {
            emptyEl.style.display = "block";
            return;
        }
        
        emptyEl.style.display = "none";
        
        // Сортируем категории по наличию избранных блюд
        const sortedCategories = Object.entries(categories).sort((a, b) => {
            const aDishes = a[1]?.dishes || {};
            const bDishes = b[1]?.dishes || {};
            const aHasFavorites = Object.values(aDishes).some(dish => dish?.favorite);
            const bHasFavorites = Object.values(bDishes).some(dish => dish?.favorite);
            
            if (aHasFavorites && !bHasFavorites) return -1;
            if (!aHasFavorites && bHasFavorites) return 1;
            return a[1].name.localeCompare(b[1].name);
        });
        
        const t = translations[currentLanguage];
        
        for (const [catId, cat] of sortedCategories) {
            const dishes = cat?.dishes || {};
            const dishCount = Object.keys(dishes).length;
            
            // Сортируем блюда внутри категории: сначала избранные
            const sortedDishes = Object.entries(dishes).sort((a, b) => {
                const aFavorite = !!a[1]?.favorite;
                const bFavorite = !!b[1]?.favorite;
                if (aFavorite && !bFavorite) return -1;
                if (!aFavorite && bFavorite) return 1;
                return 0;
            });
            
            const categoryEl = document.createElement("article");
            categoryEl.className = "card category";
            categoryEl.dataset.catId = catId;
            
            categoryEl.innerHTML = `
                <div class="category__head">
                    <button class="category__toggle" type="button" onclick="toggleDishes('${catId}')">
                        ${escapeHtml(cat.name)}
                        <span class="category__meta">• ${dishCount} ${dishCount === 1 ? 'страва' : dishCount < 5 ? 'страви' : 'страв'}</span>
                    </button>
                    <div class="category__actions">
                        <button class="icon-btn" type="button" title="${t.editText}" onclick="editCategory('${catId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn" type="button" title="${t.deleteText}" onclick="deleteCategory('${catId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="category__body">
                    <div class="add-dish-btn-container" id="add-dish-btn-${catId}">
                        <button class="btn-long" type="button" onclick="addDish('${catId}')">
                            <i class="fas fa-plus"></i>
                            <span>${t.addConfirmText} страву</span>
                        </button>
                    </div>
                    <div class="dishes" id="dishes-${catId}" style="display: none;"></div>
                </div>
            `;
            
            container.appendChild(categoryEl);
            
            // Если в категории есть блюда, рендерим их
            if (dishCount > 0) {
                renderDishes(catId, sortedDishes);
            }
        }
    }

    function toggleDishes(catId) {
        const container = document.getElementById(`dishes-${catId}`);
        const addBtnContainer = document.getElementById(`add-dish-btn-${catId}`);
        
        if (container.style.display === "block") {
            container.style.display = "none";
            addBtnContainer.classList.remove("visible");
            container.innerHTML = "";
        } else {
            // Показываем кнопку "Додати страву"
            addBtnContainer.classList.add("visible");
            
            // Если блюда еще не загружены, загружаем их
            if (container.innerHTML === "") {
                loadDishes(catId);
            }
            container.style.display = "block";
        }
    }

    function showAddMenu() {
        document.getElementById("new-category-name").value = "";
        showScreen("screen-add");
    }

    function addNewCategory() {
        const name = document.getElementById("new-category-name").value.trim();
        if (!name) {
            alert(translations[currentLanguage].enterCategoryName);
            return;
        }
        
        const catId = db.ref().push().key;
        db.ref(`users/${currentUser.uid}/categories/${catId}`)
            .set({
                name: name,
                dishes: {}
            })
            .then(() => {
                showScreen("screen-main");
                loadCategories();
            });
    }

    function editCategory(catId) {
        db.ref(`users/${currentUser.uid}/categories/${catId}/name`)
            .once("value")
            .then((snap) => {
                const oldName = snap.val() || "";
                const newName = prompt("Нова назва категорії:", oldName);
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    db.ref(`users/${currentUser.uid}/categories/${catId}/name`)
                        .set(newName.trim())
                        .then(loadCategories);
                }
            });
    }

    function deleteCategory(catId) {
        if (!confirm(translations[currentLanguage].confirmDeleteCategory)) return;
        
        db.ref(`users/${currentUser.uid}/categories/${catId}`)
            .remove()
            .then(loadCategories);
    }

    // ==================== БЛЮДА ====================
    function loadDishes(catId) {
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes`)
            .once("value")
            .then((snap) => {
                const dishes = snap.val() || {};
                // Сортируем блюда: сначала избранные
                const sortedDishes = Object.entries(dishes).sort((a, b) => {
                    const aFavorite = !!a[1]?.favorite;
                    const bFavorite = !!b[1]?.favorite;
                    if (aFavorite && !bFavorite) return -1;
                    if (!aFavorite && bFavorite) return 1;
                    return 0;
                });
                renderDishes(catId, sortedDishes);
            });
    }

    function renderDishes(catId, dishes) {
        const container = document.getElementById(`dishes-${catId}`);
        
        container.innerHTML = "";
        
        const t = translations[currentLanguage];
        
        for (const [dishId, dish] of dishes) {
            const dishEl = document.createElement("div");
            dishEl.className = "dish";
            dishEl.dataset.dishId = dishId;
            
            const hasVideo = dish.videoUrl ? "• Є відео" : "";
            const isFavorite = dish.favorite ? '<span class="tag star"><i class="fas fa-star"></i> ' + t.favoriteText + '</span>' : "";
            
            dishEl.innerHTML = `
                <div class="dish__main">
                    <p class="dish__title" role="button" onclick="openDish('${catId}', '${dishId}')">
                        ${isFavorite}${escapeHtml(dish.name)}
                    </p>
                    <p class="dish__sub">${hasVideo}</p>
                </div>
                <div class="dish__actions">
                    <button class="icon-mini" type="button" title="${dish.favorite ? t.removeFavorite || 'Прибрати з улюблених' : t.addFavorite || 'Додати в улюблені'}" onclick="toggleFavorite('${catId}', '${dishId}')">
                        ${dish.favorite ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>'}
                    </button>
                    <button class="icon-mini" type="button" title="${t.editText}" onclick="editDish('${catId}', '${dishId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-mini" type="button" title="${t.deleteText}" onclick="deleteDish('${catId}', '${dishId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(dishEl);
        }
    }

    function addDish(catId) {
        const name = prompt(translations[currentLanguage].enterDishName);
        if (!name || !name.trim()) return;
        
        const dishId = db.ref().push().key;
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}`)
            .set({
                name: name.trim(),
                description: "",
                favorite: false,
                videoUrl: ""
            })
            .then(() => {
                loadDishes(catId);
                loadCategories(); // Перезагружаем категории для обновления порядка
            });
    }

    function editDish(catId, dishId) {
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}/name`)
            .once("value")
            .then((snap) => {
                const oldName = snap.val() || "";
                const newName = prompt("Введіть нову назву страви:", oldName);
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}/name`)
                        .set(newName.trim())
                        .then(() => loadDishes(catId));
                }
            });
    }

    function deleteDish(catId, dishId) {
        if (!confirm(translations[currentLanguage].confirmDeleteDish)) return;
        
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}`)
            .remove()
            .then(() => loadDishes(catId));
    }

    function toggleFavorite(catId, dishId) {
        if (!currentUser) {
            alert(translations[currentLanguage].noAccountAlert);
            return;
        }
        
        const ref = db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}/favorite`);
        ref.once("value").then((snap) => {
            const current = !!snap.val();
            return ref.set(!current);
        }).then(() => {
            // Перезагружаем и категории, и блюда
            loadDishes(catId);
            loadCategories();
            
            // Оновлюємо кеш
            if (searchCache.categories[catId]?.dishes?.[dishId]) {
                searchCache.categories[catId].dishes[dishId].favorite = !searchCache.categories[catId].dishes[dishId].favorite;
                rebuildSearchCache(searchCache.categories);
            }
            
            // Оновити пошук, якщо активний
            const searchInput = document.getElementById("global-search");
            if (searchInput && searchInput.value.trim()) {
                renderSearchResults(searchInput.value);
            }
        });
    }

    // ==================== РЕЦЕПТЫ ====================
    function openDish(catId, dishId) {
        currentCat = catId;
        currentDish = dishId;
        
        db.ref(`users/${currentUser.uid}/categories/${catId}/dishes/${dishId}`)
            .once("value")
            .then((snap) => {
                const dish = snap.val();
                if (!dish) {
                    alert("Страва не знайдена");
                    return;
                }
                
                // Обновляем UI
                document.getElementById("recipe-name").textContent = dish.name;
                document.getElementById("recipe-display").textContent = dish.description || "";
                document.getElementById("recipe-display").contentEditable = "false";
                document.getElementById("recipe-display").classList.remove("edit-mode");
                
                // Обновляем категорию
                const catName = searchCache.categories[catId]?.name || "Невідома";
                document.getElementById("recipe-category-tag").innerHTML = `<i class="fas fa-folder"></i> <span>${translations[currentLanguage].categoryText}${catName}</span>`;
                
                // Показываем/скрываем избранное
                const favoriteTag = document.getElementById("favorite-tag");
                favoriteTag.style.display = dish.favorite ? "flex" : "none";
                
                // Показываем/скрываем кнопки редактирования
                document.getElementById("editRecipeBtn").style.display = "block";
                document.getElementById("recipe-tools").style.display = "none";
                
                // Загружаем видео
                loadVideo(dish.videoUrl);
                
                // Загружаем социальные ссылки
                loadSocialLinks(catId, dishId);
                
                showScreen("screen-recipe");
            })
            .catch(error => {
                console.error("Помилка завантаження рецепту:", error);
                alert("Не вдалося завантажити рецепт");
            });
    }

    function loadVideo(videoUrl) {
        const videoBlock = document.getElementById("video-block");
        const videoLink = document.getElementById("video-link");
        const videoFrame = document.getElementById("video-frame");
        const videoIframe = document.getElementById("video-iframe");
        const videoUrlEl = document.getElementById("video-url");
        
        if (!videoUrl || videoUrl.trim() === "") {
            videoBlock.style.display = "none";
            return;
        }
        
        videoBlock.style.display = "block";
        videoUrlEl.href = videoUrl;
        videoUrlEl.textContent = videoUrl;
        videoLink.style.display = "flex";
        
        // Конвертируем ссылку YouTube в embed
        const embedUrl = ytEmbedUrl(videoUrl);
        if (embedUrl) {
            videoIframe.src = embedUrl;
            videoFrame.style.display = "block";
        } else {
            videoFrame.style.display = "none";
        }
    }

    function ytEmbedUrl(url) {
        if (!url) return "";
        try {
            const u = new URL(url);
            const host = u.hostname.replace("www.", "");
            let id = "";
            
            if (host === "youtu.be") {
                id = u.pathname.replace("/", "").trim();
            } else if (host === "youtube.com" || host === "m.youtube.com") {
                if (u.pathname.startsWith("/watch")) {
                    id = u.searchParams.get("v") || "";
                } else if (u.pathname.startsWith("/shorts/")) {
                    id = u.pathname.split("/shorts/")[1] || "";
                } else if (u.pathname.startsWith("/embed/")) {
                    id = u.pathname.split("/embed/")[1] || "";
                }
            }
            
            id = (id || "").split("?")[0].split("&")[0].trim();
            if (!id) return "";
            
            return `https://www.youtube.com/embed/${id}`;
        } catch {
            return "";
        }
    }

    function addVideo() {
        if (!currentCat || !currentDish) return;
        
        const url = prompt(translations[currentLanguage].enterVideoUrl, "");
        if (!url || url.trim() === "") return;
        
        const cleanUrl = url.trim();
        db.ref(`users/${currentUser.uid}/categories/${currentCat}/dishes/${currentDish}/videoUrl`)
            .set(cleanUrl)
            .then(() => {
                loadVideo(cleanUrl);
                // Обновляем кеш
                if (searchCache.categories[currentCat]?.dishes?.[currentDish]) {
                    searchCache.categories[currentCat].dishes[currentDish].videoUrl = cleanUrl;
                }
            });
    }

    function startEdit() {
        const display = document.getElementById("recipe-display");
        display.contentEditable = "true";
        display.classList.add("edit-mode");
        display.focus();
        
        document.getElementById("editRecipeBtn").style.display = "none";
        document.getElementById("recipe-tools").style.display = "flex";
    }

    function saveRecipe() {
        const description = document.getElementById("recipe-display").innerText.trim();
        
        db.ref(`users/${currentUser.uid}/categories/${currentCat}/dishes/${currentDish}/description`)
            .set(description)
            .then(() => {
                cancelEdit();
                // Обновляем кеш
                if (searchCache.categories[currentCat]?.dishes?.[currentDish]) {
                    searchCache.categories[currentCat].dishes[currentDish].description = description;
                }
            });
    }

    function cancelEdit() {
        const display = document.getElementById("recipe-display");
        display.contentEditable = "false";
        display.classList.remove("edit-mode");
        
        document.getElementById("editRecipeBtn").style.display = "block";
        document.getElementById("recipe-tools").style.display = "none";
        
        // Восстанавливаем оригинальный текст
        db.ref(`users/${currentUser.uid}/categories/${currentCat}/dishes/${currentDish}/description`)
            .once("value")
            .then((snap) => {
                display.textContent = snap.val() || "";
            });
    }

    function goBackFromRecipe() {
        currentCat = null;
        currentDish = null;
        showScreen("screen-main");
    }

    // ==================== ПОИСК ====================
    function initSearch() {
        const searchInput = document.getElementById("global-search");
        const clearBtn = document.getElementById("clearSearchBtn");
        
        if (!searchInput) return;
        
        // Обработка ввода с проверкой на email
        searchInput.addEventListener("input", () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const value = searchInput.value.trim();
                // Проверяем, не является ли ввод email-ом
                if (value.includes('@') && value.includes('.')) {
                    // Это похоже на email, не выполняем поиск
                    return;
                }
                renderSearchResults(value);
            }, 300);
        });
        
        // Очистка поиска
        clearBtn.addEventListener("click", () => {
            searchInput.value = "";
            renderSearchResults("");
        });
        
        // Обработка клавиши Escape
        searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                searchInput.value = "";
                renderSearchResults("");
            }
        });
    }

    function renderSearchResults(query) {
        const resultsPanel = document.getElementById("search-results");
        const categoriesList = document.getElementById("categories");
        
        if (!resultsPanel) return;
        
        query = norm(query);
        
        // Если ввод похож на email, не показываем результаты
        if (query.includes('@') && query.includes('.')) {
            resultsPanel.style.display = "none";
            categoriesList.style.display = "block";
            return;
        }
        
        // Если запрос пустой, показываем категории
        if (!query) {
            resultsPanel.style.display = "none";
            categoriesList.style.display = "block";
            return;
        }
        
        // Фильтруем результаты
        const favoriteMode = query === "улюблене" || query === "улюблені" || query.includes("улюб") || query === "favorite" || query === "favourites";
        
        const matchedCats = [];
        const matchedDishes = [];
        
        if (favoriteMode) {
            // Ищем только избранные блюда
            searchCache.flatDishes.forEach(dish => {
                if (dish.favorite) matchedDishes.push(dish);
            });
        } else {
            // Обычный поиск
            searchCache.flatCats.forEach(cat => {
                if (includesLoose(cat.name, query)) matchedCats.push(cat);
            });
            
            searchCache.flatDishes.forEach(dish => {
                if (includesLoose(dish.name, query) || includesLoose(dish.catName, query)) {
                    matchedDishes.push(dish);
                }
            });
        }
        
        // Сортируем результаты: сначала избранные блюда
        matchedDishes.sort((a, b) => {
            if (a.favorite !== b.favorite) return a.favorite ? -1 : 1;
            return norm(a.name).localeCompare(norm(b.name));
        });
        
        matchedCats.sort((a, b) => {
            if (a.hasFavorites && !b.hasFavorites) return -1;
            if (!a.hasFavorites && b.hasFavorites) return 1;
            return norm(a.name).localeCompare(norm(b.name));
        });
        
        const t = translations[currentLanguage];
        
        // Рендерим результаты
        let html = "";
        
        if (favoriteMode) {
            html += `<div style="margin:.5rem 0 1rem;color:var(--secondary);font-weight:900;font-size:1.1rem;"><i class="fas fa-star"></i> ${t.favoriteText}</div>`;
        } else if (matchedCats.length > 0 || matchedDishes.length > 0) {
            html += `<div style="margin:.5rem 0 1rem;color:var(--secondary);font-weight:900;font-size:1.1rem;">${t.searchResults || 'Результати пошуку'}</div>`;
        }
        
        // Если результатов нет
        if (matchedCats.length === 0 && matchedDishes.length === 0) {
            html += `
                <div class="empty">
                    <i class="fas fa-search"></i>
                    <p>${t.noResults || 'Нічого не знайдено. Спробуйте інший запит.'}</p>
                </div>
            `;
        }
        
        // Категории
        if (!favoriteMode && matchedCats.length > 0) {
            html += `<div style="margin-bottom:.7rem;color:var(--text);font-weight:800;">${t.categories || 'Категорії'}</div>`;
            matchedCats.forEach(cat => {
                html += `
                    <article class="result" data-type="category">
                        <div class="result__top">
                            <h3 class="result__title"><i class="fas fa-folder"></i> ${escapeHtml(cat.name)}</h3>
                            <div class="result__type">${t.category || 'Категорія'}</div>
                        </div>
                        <p class="result__desc">${t.found || 'Знайдено'} ${cat.dishesCount} ${cat.dishesCount === 1 ? t.dishSingular || 'страва' : cat.dishesCount < 5 ? t.dishPlural || 'страви' : t.dishMany || 'страв'} ${t.inCategory || 'у категорії'}</p>
                        <div class="result__actions">
                            <button class="btn-outline" type="button" onclick="openSearchCategory('${cat.catId}')">
                                <i class="fas fa-folder-open"></i>
                                ${t.openCategory || 'Відкрити категорію'}
                            </button>
                        </div>
                    </article>
                `;
            });
        }
        
        // Блюда
        if (matchedDishes.length > 0) {
            html += `<div style="margin:.7rem 0 .4rem;color:var(--text);font-weight:800;">${t.dishes || 'Страви'}</div>`;
            matchedDishes.forEach(dish => {
                const star = dish.favorite ? '<i class="fas fa-star"></i> ' : '';
                const hasVideo = dish.videoUrl ? '• ' + t.hasVideo || 'Є відео' : '';
                
                html += `
                    <article class="result" data-type="dish">
                        <div class="result__top">
                            <h3 class="result__title">${star}${escapeHtml(dish.name)}</h3>
                            <div class="result__type">${t.dish || 'Страва'}</div>
                        </div>
                        <p class="result__desc"><i class="fas fa-folder"></i> ${t.category || 'Категорія'}: ${escapeHtml(dish.catName)} ${hasVideo}</p>
                        <div class="result__actions">
                            <button class="btn-outline" type="button" onclick="openSearchDish('${dish.catId}', '${dish.dishId}')">
                                <i class="fas fa-book-open"></i>
                                ${t.openRecipe || 'Відкрити рецепт'}
                            </button>
                        </div>
                    </article>
                `;
            });
        }
        
        resultsPanel.innerHTML = html;
        resultsPanel.style.display = "block";
        categoriesList.style.display = "none";
    }

    function openSearchCategory(catId) {
        const searchInput = document.getElementById("global-search");
        searchInput.value = "";
        
        showScreen("screen-main");
        document.getElementById("search-results").style.display = "none";
        document.getElementById("categories").style.display = "block";
        
        // Раскрываем категорию
        toggleDishes(catId);
        
        // Прокручиваем до категории
        const catEl = document.querySelector(`[data-cat-id="${catId}"]`);
        if (catEl) {
            catEl.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }

    function openSearchDish(catId, dishId) {
        const searchInput = document.getElementById("global-search");
        searchInput.value = "";
        
        openDish(catId, dishId);
    }

    // ==================== ИНИЦИАЛИЗАЦИЯ ====================
    document.addEventListener("DOMContentLoaded", () => {
        // Загружаем настройки
        loadSettings();
        
        // Привязываем события
        document.getElementById("authButton").addEventListener("click", toggleAuthMenu);
        document.getElementById("addCategoryBtn").addEventListener("click", showAddMenu);
        document.getElementById("backFromAddBtn").addEventListener("click", () => showScreen("screen-main"));
        document.getElementById("addCategoryConfirmBtn").addEventListener("click", addNewCategory);
        document.getElementById("backFromRecipeBtn").addEventListener("click", goBackFromRecipe);
        document.getElementById("editRecipeBtn").addEventListener("click", startEdit);
        document.getElementById("saveRecipeBtn").addEventListener("click", saveRecipe);
        document.getElementById("cancelEditBtn").addEventListener("click", cancelEdit);
        document.getElementById("addVideoBtn").addEventListener("click", addVideo);
        document.getElementById("addSocialLinkBtn").addEventListener("click", addSocialLink);
        
        // Инициализация настроек
        initSettings();
        
        // Инициализация поиска
        initSearch();
        
        // Показываем главный экран
        showScreen("screen-main");
    });
    </script>
</body>
</html>
